<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <title>Git Merge Battle</title>
   <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
   <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <style>
       * { 
           margin: 0; 
           padding: 0; 
           box-sizing: border-box; 
       }

       body {
           font-family: 'Pretendard', sans-serif;
           background: #2a2a2a;
           color: #ffffff;
           line-height: 1.6;
           min-height: 100vh;
           display: flex;
           align-items: center;
           justify-content: center;
       }

       .container {
           width: 100%;
           max-width: 600px;
           padding: 40px;
       }

       .screen {
           display: none;
           text-align: center;
       }

       .screen.active {
           display: block;
           animation: fadeIn 0.3s ease-out;
       }

       @keyframes fadeIn {
           from { opacity: 0; transform: translateY(10px); }
           to { opacity: 1; transform: translateY(0); }
       }

       .title {
           font-size: 2.5rem;
           font-weight: 700;
           margin-bottom: 3rem;
           color: #ffffff;
       }

       .subtitle {
           color: #cccccc;
           margin-bottom: 2rem;
           font-size: 1rem;
       }

       .room-info-box {
           background: #3a3a3a;
           border-radius: 12px;
           padding: 30px;
           margin: 30px 0;
           text-align: center;
       }

       .room-label {
           color: #999999;
           font-size: 0.9rem;
           margin-bottom: 10px;
       }

       .room-code {
           font-size: 3rem;
           font-family: 'SF Mono', 'Courier New', monospace;
           font-weight: 700;
           color: #ffffff;
           margin: 15px 0;
           letter-spacing: 6px;
       }

       .room-name {
           color: #cccccc;
           font-size: 1.1rem;
           margin-bottom: 20px;
       }

       .copy-button {
           background: #4a4a4a;
           border: none;
           color: #ffffff;
           padding: 8px 20px;
           border-radius: 6px;
           font-size: 0.9rem;
           cursor: pointer;
           font-family: inherit;
       }

       .copy-button:hover {
           background: #555555;
       }

       .player-box {
           background: #3a3a3a;
           border-radius: 12px;
           padding: 20px;
           margin: 20px 0;
       }

       .player-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 15px 0;
           border-bottom: 1px solid #4a4a4a;
       }

       .player-item:last-child {
           border-bottom: none;
       }

       .player-name {
           color: #ffffff;
           font-weight: 500;
       }

       .player-role {
           color: #999999;
           font-size: 0.9rem;
           margin-left: 8px;
       }

       .player-status {
           color: #00ff00;
           font-size: 0.9rem;
           font-weight: 500;
       }

       .player-status.waiting {
           color: #999999;
       }

       .action-button {
           width: 100%;
           background: #4a4a4a;
           border: none;
           color: #ffffff;
           padding: 15px;
           border-radius: 8px;
           font-size: 1rem;
           cursor: pointer;
           margin: 10px 0;
           font-family: inherit;
           font-weight: 500;
       }

       .action-button:hover {
           background: #555555;
       }

       .action-button:disabled {
           background: #333333;
           color: #666666;
           cursor: not-allowed;
       }

       input {
           width: 100%;
           padding: 15px;
           background: #3a3a3a;
           border: 1px solid #4a4a4a;
           border-radius: 8px;
           color: #ffffff;
           font-size: 1rem;
           margin: 10px 0;
           font-family: inherit;
       }

       input:focus {
           outline: none;
           border-color: #666666;
       }

       input::placeholder {
           color: #999999;
       }

       .btn-group {
           display: grid;
           grid-template-columns: 1fr 1fr;
           gap: 15px;
           margin: 20px 0;
       }
   </style>
</head>
<body>
   <div class="container">
       <div class="screen active" id="menuScreen">
           <h1 class="title">Git Merge Battle</h1>
           <p class="subtitle">닉네임: <strong id="displayNickname">입력하세요</strong></p>
           
           <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="16">
           
           <div class="btn-group">
               <button class="action-button" id="createRoomBtn">방 만들기</button>
               <button class="action-button" id="joinRoomBtn">방 참가하기</button>
           </div>
           
           <button class="action-button" onclick="location.href='index.html'">메인 메뉴로</button>
           <div id="status" style="color: #999999; margin-top: 20px;"></div>
       </div>

       <div class="screen" id="createScreen">
           <h1 class="title">방 만들기</h1>
           <input type="text" id="roomNameInput" placeholder="방 이름을 입력하세요" value="내 방" maxlength="20">
           <button class="action-button" id="confirmCreateBtn">방 생성하기</button>
           <button class="action-button" id="backFromCreateBtn">뒤로가기</button>
       </div>

       <div class="screen" id="joinScreen">
           <h1 class="title">방 참가하기</h1>
           <input type="text" id="roomCodeInput" placeholder="6자리 방 코드 입력" maxlength="6" style="text-transform: uppercase;">
           <button class="action-button" id="confirmJoinBtn">입장하기</button>
           <button class="action-button" id="backFromJoinBtn">뒤로가기</button>
       </div>

       <div class="screen" id="roomScreen">
           <h1 class="title">대기실</h1>
           
           <div class="room-info-box">
               <div class="room-label">방 코드</div>
               <div class="room-code" id="displayRoomCode">------</div>
               <div class="room-name" id="displayRoomName">대기 중...</div>
               <button class="copy-button" onclick="copyRoomCode()">코드 복사</button>
           </div>
           
           <div class="player-box" id="playerList"></div>
           
           <button class="action-button" id="readyBtn">준비하기</button>
           <button class="action-button" id="startGameBtn" style="display: none;">게임 시작</button>
           <button class="action-button" id="leaveBtn">방 나가기</button>
           
           <div id="roomStatus" style="color: #999999; margin-top: 20px;"></div>
       </div>

       <div class="screen" id="gameScreen">
           <h1 class="title">게임 시작!</h1>
           <p style="color: #cccccc; margin-bottom: 30px;">실시간 대전이 곧 시작됩니다...</p>
           <button class="action-button" onclick="alert('게임 기능 개발 중입니다!')">테스트</button>
       </div>
   </div>

   <script>
       class BattleGame {
           constructor() {
               this.stompClient = null;
               this.nickname = localStorage.getItem('gitmerge_nickname') || '';
               this.currentRoomCode = '';
               this.isHost = false;
               
               this.initializeUI();
               this.bindEvents();
           }
           
           initializeUI() {
               const nicknameInput = document.getElementById('nicknameInput');
               const displayNickname = document.getElementById('displayNickname');
               
               if (this.nickname) {
                   nicknameInput.value = this.nickname;
                   displayNickname.textContent = this.nickname;
               }
               
               nicknameInput.addEventListener('input', (e) => {
                   this.nickname = e.target.value.trim();
                   displayNickname.textContent = this.nickname || '입력하세요';
                   localStorage.setItem('gitmerge_nickname', this.nickname);
               });
           }
           
           bindEvents() {
               const eventMap = {
                   'createRoomBtn': () => this.validateAndProceed('createScreen'),
                   'joinRoomBtn': () => this.validateAndProceed('joinScreen'),
                   'confirmCreateBtn': () => this.createRoom(),
                   'confirmJoinBtn': () => this.joinRoom(),
                   'backFromCreateBtn': () => this.showScreen('menuScreen'),
                   'backFromJoinBtn': () => this.showScreen('menuScreen'),
                   'readyBtn': () => this.toggleReady(),
                   'startGameBtn': () => this.startGame(),
                   'leaveBtn': () => this.leaveRoom()
               };
               
               Object.entries(eventMap).forEach(([id, handler]) => {
                   document.getElementById(id).addEventListener('click', handler);
               });
           }
           
           validateAndProceed(screenId) {
               if (!this.nickname) {
                   alert('닉네임을 입력하세요');
                   document.getElementById('nicknameInput').focus();
                   return;
               }
               this.showScreen(screenId);
           }
           
           updateStatus(message, elementId = 'status') {
               const element = document.getElementById(elementId);
               if (element) {
                   element.textContent = message;
               }
           }
           
           createRoom() {
               const roomName = document.getElementById('roomNameInput').value.trim() || '새로운 방';
               this.isHost = true;
               this.updateStatus('방 생성 중...');
               
               this.connectWebSocket(() => {
                   this.stompClient.send('/app/room/create', {}, JSON.stringify({
                       nickname: this.nickname,
                       roomName: roomName
                   }));
               });
           }
           
           joinRoom() {
               const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
               
               if (roomCode.length !== 6) {
                   alert('6자리 방 코드를 입력하세요');
                   return;
               }
               
               this.isHost = false;
               this.updateStatus('방 참가 중...');
               
               this.connectWebSocket(() => {
                   this.stompClient.subscribe(`/topic/room/${roomCode}`, (message) => {
                       this.handleRoomMessage(JSON.parse(message.body));
                   });
                   
                   this.stompClient.send('/app/room/join', {}, JSON.stringify({
                       nickname: this.nickname,
                       roomCode: roomCode
                   }));
               });
           }
           
           toggleReady() {
               if (!this.stompClient?.connected) return;
               
               this.stompClient.send('/app/room/ready', {}, JSON.stringify({
                   nickname: this.nickname
               }));
           }
           
           startGame() {
               if (!this.stompClient?.connected || !this.isHost) return;
               
               this.stompClient.send('/app/room/start', {}, JSON.stringify({
                   nickname: this.nickname
               }));
           }
           
           leaveRoom() {
               this.showScreen('menuScreen');
               if (this.stompClient?.connected) {
                   this.stompClient.disconnect();
               }
               this.currentRoomCode = '';
           }
           
           connectWebSocket(onReady) {
               if (this.stompClient?.connected) {
                   onReady?.();
                   return;
               }
               
               const socket = new SockJS('/ws/match');
               this.stompClient = Stomp.over(socket);
               
               this.stompClient.connect({}, () => {
                   this.updateStatus('연결됨');
                   this.setupSubscriptions();
                   onReady?.();
               }, (error) => {
                   this.updateStatus('연결 실패');
               });
           }
           
           setupSubscriptions() {
               this.stompClient.subscribe('/topic/room-created', (message) => {
                   const data = JSON.parse(message.body);
                   if (data.creator === this.nickname) {
                       this.handleRoomCreated(data);
                   }
               });
               
               this.stompClient.subscribe('/user/queue/error', (message) => {
                   const data = JSON.parse(message.body);
                   this.updateStatus('오류: ' + data.message);
                   alert(data.message);
               });
           }
           
           handleRoomCreated(data) {
               this.currentRoomCode = data.roomCode;
               document.getElementById('displayRoomCode').textContent = data.roomCode;
               document.getElementById('displayRoomName').textContent = data.roomName;
               this.updatePlayerList(data.players);
               this.updateStatus('방 생성 완료');
               this.showScreen('roomScreen');
               
               this.stompClient.subscribe(`/topic/room/${data.roomCode}`, (message) => {
                   this.handleRoomMessage(JSON.parse(message.body));
               });
           }
           
           handleRoomMessage(data) {
               switch (data.type) {
                   case 'PLAYER_JOINED':
                       this.handlePlayerJoined(data);
                       break;
                   case 'PLAYER_READY':
                       this.handlePlayerReady(data);
                       break;
                   case 'GAME_START':
                       this.handleGameStart();
                       break;
               }
           }
           
           handlePlayerJoined(data) {
               this.currentRoomCode = data.roomCode;
               document.getElementById('displayRoomCode').textContent = data.roomCode;
               document.getElementById('displayRoomName').textContent = data.roomName;
               this.updatePlayerList(data.players);
               this.updateStatus('방 입장 완료', 'roomStatus');
               this.showScreen('roomScreen');
           }
           
           handlePlayerReady(data) {
               this.updatePlayerList(data.players);
               this.updateStatus(data.player + '님이 준비 상태를 변경했습니다', 'roomStatus');
               this.checkGameStartCondition(data.players);
           }
           
           handleGameStart() {
               this.updateStatus('게임 시작!', 'roomStatus');
               this.showScreen('gameScreen');
           }
           
           updatePlayerList(players) {
               const playerList = document.getElementById('playerList');
               const playerArray = Object.values(players || {});
               
               if (playerArray.length === 0) {
                   playerList.innerHTML = '<div style="text-align: center; color: #999999;">플레이어가 없습니다</div>';
                   return;
               }
               
               playerList.innerHTML = playerArray.map(player => `
                   <div class="player-item">
                       <div>
                           <span class="player-name">${player.nickname}</span>
                           ${player.isHost ? '<span class="player-role">(방장)</span>' : ''}
                       </div>
                       <div class="player-status ${player.ready ? '' : 'waiting'}">
                           ${player.ready ? '준비완료' : '대기중'}
                       </div>
                   </div>
               `).join('');
           }
           
           checkGameStartCondition(players) {
               const playerArray = Object.values(players || {});
               const allReady = playerArray.every(p => p.ready);
               const hasMinPlayers = playerArray.length >= 2;
               
               const startBtn = document.getElementById('startGameBtn');
               startBtn.style.display = (this.isHost && allReady && hasMinPlayers) ? 'block' : 'none';
               
               if (allReady && hasMinPlayers) {
                   this.updateStatus('모든 플레이어가 준비되었습니다!', 'roomStatus');
               }
           }
           
           showScreen(screenId) {
               document.querySelectorAll('.screen').forEach(screen => {
                   screen.classList.remove('active');
               });
               document.getElementById(screenId).classList.add('active');
           }
       }
       
       function copyRoomCode() {
           const game = window.battleGame;
           if (game && game.currentRoomCode) {
               navigator.clipboard.writeText(game.currentRoomCode).then(() => {
                   alert('방 코드가 복사되었습니다: ' + game.currentRoomCode);
               });
           }
       }
       
       document.addEventListener('DOMContentLoaded', () => {
           window.battleGame = new BattleGame();
       });
   </script>
</body>
</html>
