<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <title>Git Merge Battle</title>
   <style>
       body {
           font-family: Arial;
           background: #111;
           color: #fff;
           margin: 0;
           padding: 20px;
       }
       .screen {
           display: none;
           max-width: 600px;
           margin: 0 auto;
           padding: 40px;
           background: #222;
           border-radius: 8px;
       }
       .screen.active {
           display: block;
       }
       .title {
           text-align: center;
           font-size: 2rem;
           margin-bottom: 30px;
       }
       input, button {
           padding: 15px;
           font-size: 1rem;
           border-radius: 6px;
           border: 1px solid #444;
           background: #333;
           color: #fff;
           margin: 10px 0;
           width: 100%;
       }
       button:hover {
           background: #555;
           cursor: pointer;
       }
       button:disabled {
           background: #222;
           color: #666;
           cursor: not-allowed;
       }
       .mode-grid {
           display: grid;
           grid-template-columns: 1fr 1fr;
           gap: 20px;
       }
       .mode-btn {
           padding: 40px 20px;
           background: #333;
           border-radius: 8px;
           text-align: center;
           cursor: pointer;
       }
       .mode-btn:hover {
           background: #444;
       }
       .difficulty-grid {
           display: grid;
           grid-template-columns: 1fr 1fr;
           gap: 15px;
           margin: 20px 0;
       }
       .difficulty-btn {
           padding: 20px;
           text-align: center;
           border: 2px solid #444;
           border-radius: 8px;
           cursor: pointer;
       }
       .difficulty-btn.selected {
           border-color: #0f0;
           background: #040;
       }
       .game-area {
           display: grid;
           grid-template-columns: 1fr 250px;
           gap: 20px;
       }
       .code-editor {
           width: 100%;
           height: 300px;
           background: #0d1117;
           color: #e6edf3;
           border: none;
           padding: 20px;
           font-family: monospace;
           font-size: 14px;
           resize: none;
       }
       .sidebar {
           background: #333;
           padding: 20px;
           border-radius: 8px;
       }
       .status {
           margin: 10px 0;
           padding: 10px;
           background: #444;
           border-radius: 4px;
       }
   </style>
</head>
<body>
   <div class="screen active" id="nicknameScreen">
       <h1 class="title">Git Merge Battle</h1>
       <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="12">
       <button id="enterBtn" disabled>입장하기</button>
   </div>

   <div class="screen" id="modeScreen">
       <h1 class="title">모드 선택</h1>
       <div class="mode-grid">
           <div class="mode-btn" onclick="showSoloDifficulty()">
               <div>혼자하기</div>
               <small>솔로 모드</small>
           </div>
           <div class="mode-btn" onclick="startBattle()">
               <div>실시간 대전</div>
               <small>멀티플레이어</small>
           </div>
       </div>
   </div>

   <div class="screen" id="difficultyScreen">
       <h1 class="title">난이도 선택</h1>
       <div class="difficulty-grid">
           <div class="difficulty-btn" data-difficulty="EASY">
               <div>쉬움</div>
               <small>3개 충돌</small>
           </div>
           <div class="difficulty-btn" data-difficulty="NORMAL">
               <div>보통</div>
               <small>5개 충돌</small>
           </div>
           <div class="difficulty-btn" data-difficulty="HARD">
               <div>어려움</div>
               <small>8개 충돌</small>
           </div>
           <div class="difficulty-btn" data-difficulty="HELL">
               <div>지옥</div>
               <small>12개 충돌</small>
           </div>
       </div>
       <button id="startSoloBtn" disabled>게임 시작</button>
       <button onclick="showScreen('modeScreen')">뒤로</button>
   </div>

   <div class="screen" id="gameScreen">
       <h1 class="title">솔로 게임</h1>
       <div class="game-area">
           <div>
               <div id="fileHeader" style="background: #444; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                   src/main/conflict.js
               </div>
               <textarea class="code-editor" id="codeEditor" placeholder="충돌을 해결하세요..."></textarea>
               <button id="submitBtn">답안 제출</button>
               <div id="resultMessage" style="display: none; margin: 10px 0; padding: 10px; border-radius: 4px;"></div>
           </div>
           <div class="sidebar">
               <div class="status">
                   <div>문제: <span id="questionStatus">1/3</span></div>
               </div>
               <div class="status">
                   <div>정답: <span id="correctCount">0</span></div>
               </div>
               <div class="status">
                   <div>오답: <span id="wrongCount">0</span></div>
               </div>
               <div class="status">
                   <div>시간: <span id="timeElapsed">00:00</span></div>
               </div>
           </div>
       </div>
   </div>

   <div class="screen" id="resultScreen">
       <h1 class="title">게임 완료</h1>
       <div style="text-align: center;">
           <div style="font-size: 3rem; margin: 20px 0;" id="finalScore">1500</div>
           <div style="margin: 20px 0;">
               <div>정확도: <span id="accuracyRate">85%</span></div>
               <div>소요시간: <span id="finalTime">02:34</span></div>
               <div>해결률: <span id="totalSolved">7/8</span></div>
           </div>
           <button onclick="showScreen('modeScreen')">다시하기</button>
       </div>
   </div>

   <script>
       let nickname = '';
       let selectedDifficulty = '';
       let currentSession = null;
       let gameStartTime = null;
       
       document.getElementById('nicknameInput').addEventListener('input', function() {
           document.getElementById('enterBtn').disabled = this.value.trim().length < 2;
       });
       
       document.getElementById('enterBtn').addEventListener('click', function() {
           nickname = document.getElementById('nicknameInput').value.trim();
           localStorage.setItem('gitmerge_nickname', nickname);
           showScreen('modeScreen');
       });
       
       document.querySelectorAll('.difficulty-btn').forEach(btn => {
           btn.addEventListener('click', function() {
               document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
               this.classList.add('selected');
               selectedDifficulty = this.dataset.difficulty;
               document.getElementById('startSoloBtn').disabled = false;
           });
       });
       
       document.getElementById('startSoloBtn').addEventListener('click', startSoloGame);
       document.getElementById('submitBtn').addEventListener('click', submitAnswer);
       
       function showSoloDifficulty() {
           showScreen('difficultyScreen');
       }
       
       function startBattle() {
           window.location.href = 'battle.html';
       }
       
       async function startSoloGame() {
           try {
               const response = await fetch('/api/quick/start', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       nickname: nickname,
                       difficulty: selectedDifficulty
                   })
               });
               
               if (response.ok) {
                   const data = await response.json();
                   currentSession = data;
                   gameStartTime = Date.now();
                   displayConflict(data.currentConflict);
                   showScreen('gameScreen');
                   startTimer();
               } else {
                   alert('게임 시작 실패');
               }
           } catch (error) {
               alert('서버 연결 오류');
           }
       }
       
       function displayConflict(conflict) {
           document.getElementById('fileHeader').textContent = `src/main/${conflict.fileName}`;
           document.getElementById('codeEditor').value = conflict.conflictMarkers;
           document.getElementById('questionStatus').textContent = 
               `${currentSession.currentIndex + 1}/${currentSession.totalConflicts}`;
       }
       
       async function submitAnswer() {
           const answer = document.getElementById('codeEditor').value.trim();
           
           try {
               const response = await fetch('/api/quick/submit', {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       sessionId: currentSession.sessionId,
                       answer: answer
                   })
               });
               
               if (response.ok) {
                   const result = await response.json();
                   showResult(result);
                   
                   if (result.correct) {
                       updateCorrectCount();
                   } else {
                       updateWrongCount();
                   }
                   
                   if (result.gameOver) {
                       setTimeout(showFinalResult, 2000);
                   } else if (result.nextConflict) {
                       setTimeout(() => displayConflict(result.nextConflict), 2000);
                   }
               }
           } catch (error) {
               alert('제출 오류');
           }
       }
       
       function showResult(result) {
           const messageDiv = document.getElementById('resultMessage');
           messageDiv.textContent = result.message;
           messageDiv.style.display = 'block';
           messageDiv.style.background = result.correct ? '#040' : '#400';
           messageDiv.style.color = result.correct ? '#0f0' : '#f00';
           
           setTimeout(() => {
               messageDiv.style.display = 'none';
           }, 2000);
       }
       
       function updateCorrectCount() {
           const current = parseInt(document.getElementById('correctCount').textContent);
           document.getElementById('correctCount').textContent = current + 1;
       }
       
       function updateWrongCount() {
           const current = parseInt(document.getElementById('wrongCount').textContent);
           document.getElementById('wrongCount').textContent = current + 1;
       }
       
       async function showFinalResult() {
           try {
               const response = await fetch(`/api/quick/result/${currentSession.sessionId}`);
               if (response.ok) {
                   const result = await response.json();
                   
                   document.getElementById('finalScore').textContent = result.totalScore;
                   document.getElementById('accuracyRate').textContent = 
                       Math.round((result.correctCount / result.totalQuestions) * 100) + '%';
                   document.getElementById('finalTime').textContent = 
                       Math.floor(result.elapsedSeconds / 60) + ':' + 
                       String(result.elapsedSeconds % 60).padStart(2, '0');
                   document.getElementById('totalSolved').textContent = 
                       `${result.correctCount}/${result.totalQuestions}`;
                   
                   showScreen('resultScreen');
               }
           } catch (error) {
               showScreen('resultScreen');
           }
       }
       
       function startTimer() {
           setInterval(() => {
               if (gameStartTime) {
                   const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                   const minutes = Math.floor(elapsed / 60);
                   const seconds = elapsed % 60;
                   document.getElementById('timeElapsed').textContent = 
                       String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
               }
           }, 1000);
       }
       
       function showScreen(screenId) {
           document.querySelectorAll('.screen').forEach(screen => {
               screen.classList.remove('active');
           });
           document.getElementById(screenId).classList.add('active');
       }
   </script>
</body>
</html>
